# .github/workflows/pages-processes.yml
name: Publish processes (AzPS container) to Pages

on:
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    container: mcr.microsoft.com/azure-powershell:latest

    steps:
      - uses: actions/checkout@v4

      - name: Generate HTML with ConvertTo-Html
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path site | Out-Null

          $now = Get-Date -Format u

          $proc = Get-Process |
            Sort-Object -Property WorkingSet64 -Descending |
            Select-Object -First 200 -Property `
              ProcessName, Id, `
              @{N='CPU(s)';E={$_.CPU}}, `
              @{N='WS(MB)';E={[math]::Round($_.WorkingSet64/1MB,1)}}

          # Build <head> without here-strings
          $head = @(
            '<meta charset="utf-8"/>'
            '<meta name="viewport" content="width=device-width, initial-scale=1"/>'
            '<style>'
            '  body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:2rem;}'
            '  h1{margin:0 0 .5rem 0;}'
            '  .muted{color:#666}'
            '  table{border-collapse:collapse;width:100%;max-width:1100px}'
            '  th,td{border:1px solid #e5e7eb;padding:.5rem;text-align:left}'
            '  th{background:#f6f8fa}'
            '  tbody tr:nth-child(even){background:#fafafa}'
            '</style>'
          ) -join "`n"

          $pre = "<h1>Processes (Azure PowerShell container snapshot)</h1><p class='muted'>Updated on $now â€¢ Top 200 by Working Set</p>"

          $proc |
            ConvertTo-Html -As Table -Title 'Processes (Azure PowerShell container)' -PreContent $pre -Head $head |
            Set-Content -Path site/index.html -Encoding UTF8

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - id: deployment
        uses: actions/deploy-pages@v4
